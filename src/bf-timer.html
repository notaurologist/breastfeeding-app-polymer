<link rel="import" href="../bower_components/polymer/polymer.html">

<dom-module id="bf-timer">
  <template>
    <style>
      .container {
        align-items: center;
        color: tomato;
        display: flex;
        justify-content: center;
      }

      .seconds {
        height: 200px;
        transform: rotate(-90deg);
        width: 200px;
      }

      .track,
      .progress {
        stroke-width: 1em;
      }

      .track {
        stroke: #ccc;
      }

      .progress {
        stroke: currentColor;
        transition: stroke-dashoffset 0.016s linear;
      }

      .minutes {
        font-size: 4em;
        left: 50%;
        position: absolute;
        transform: translateX(-50%);
      }
    </style>

    <div class="container" on-tap="_toggleTimer">
      <div class="minutes">[[_computeMinutes(seconds)]]</div>
      <svg class="seconds">
        <circle
          class="track"
          r="90"
          cx="100"
          cy="100"
          fill="transparent"></circle>
        <circle
          class="progress"
          style$="stroke-dashoffset: [[_computeStrokeDashoffset(seconds)]]"
          r="90"
          cx="100"
          cy="100"
          fill="transparent"
          stroke-dasharray$="[[_maxOffset]]"></circle>
      </svg>
    </div>
  </template>

  <script>
    Polymer({
      is: 'bf-timer',

      properties: {
        _requestId: Number,
        _maxOffset: {
          type: Number,
          value: 565.48,
          readOnly: true,
        },
        active: Boolean,
        start: Number,
        seconds: {
          type: Number,
          value: 0,
        },
      },

      detached: function () {
        window.cancelAnimationFrame(this._requestId);
      },

      _computeMinutes: function (seconds) {
        return Math.floor(seconds / 60);
      },

      _computeStrokeDashoffset: function (seconds) {
        // TODO: Tweak accuracy of this. Minutes change just before complete.
        return this._maxOffset - (seconds / 60) * Math.PI * 180;
      },

      _toggleTimer: function (evt) {
        evt.preventDefault();
        if (!this.active) {
          this._requestId = window.requestAnimationFrame(this._progress.bind(this));
          this.active = true;
        } else {
          window.cancelAnimationFrame(this._requestId);
          this.active = false;
          // const finalTime = new Date(performance.now() - start);
          // const seconds = finalTime.getSeconds();
          // TODO: Do something with the final time
        }
      },

      _progress: function (ms) {
        // TODO: Need to handle start/stop.
        // ms is just an ongoing timestamp (i.e., pausing doesn't reset it),
        // so we need to remove the pause time from the counter.
        if (!this.start) {
          this.start = ms;
        }

        this.seconds = (ms - this.start) / 1000;

        this._requestId = window.requestAnimationFrame(this._progress.bind(this));
      },
    });
  </script>
</dom-module>
